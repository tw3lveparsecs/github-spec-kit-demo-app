name: Infrastructure - Bicep Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Deployment action'
        required: true
        default: 'what-if'
        type: choice
        options:
          - what-if
          - deploy

env:
  RESOURCE_GROUP_DEV: rg-speckit-demo-dev
  RESOURCE_GROUP_PROD: rg-speckit-demo-prod
  LOCATION: eastus

jobs:
  # Validate Bicep templates
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Validate Bicep syntax
        run: |
          az bicep build --file infra/main.bicep --stdout > /dev/null

      - name: Validate deployment
        run: |
          az deployment group validate \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }} \
            --template-file infra/main.bicep \
            --parameters infra/parameters/dev.bicepparam

  # What-If Preview
  what-if:
    name: What-If Preview
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'what-if'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: Run What-If
        run: |
          RESOURCE_GROUP=${{ github.event.inputs.environment == 'prod' && env.RESOURCE_GROUP_PROD || env.RESOURCE_GROUP_DEV }}
          PARAMS_FILE=infra/parameters/${{ github.event.inputs.environment }}.bicepparam
          
          az deployment group what-if \
            --resource-group $RESOURCE_GROUP \
            --template-file infra/main.bicep \
            --parameters $PARAMS_FILE

  # Deploy Infrastructure
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.action == 'deploy'
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_CREDENTIALS_PROD || secrets.AZURE_CREDENTIALS_DEV }}

      - name: Create Resource Group
        run: |
          RESOURCE_GROUP=${{ github.event.inputs.environment == 'prod' && env.RESOURCE_GROUP_PROD || env.RESOURCE_GROUP_DEV }}
          
          az group create \
            --name $RESOURCE_GROUP \
            --location ${{ env.LOCATION }} \
            --tags environment=${{ github.event.inputs.environment }} project=speckit-demo

      - name: Deploy Bicep Template
        id: deploy
        run: |
          RESOURCE_GROUP=${{ github.event.inputs.environment == 'prod' && env.RESOURCE_GROUP_PROD || env.RESOURCE_GROUP_DEV }}
          PARAMS_FILE=infra/parameters/${{ github.event.inputs.environment }}.bicepparam
          
          result=$(az deployment group create \
            --resource-group $RESOURCE_GROUP \
            --template-file infra/main.bicep \
            --parameters $PARAMS_FILE \
            --query 'properties.outputs' \
            --output json)
          
          echo "Deployment outputs:"
          echo "$result"
          
          # Extract outputs for use in subsequent steps
          webAppUrl=$(echo $result | jq -r '.webAppUrl.value')
          echo "webapp_url=$webAppUrl" >> $GITHUB_OUTPUT

      - name: Verify Infrastructure
        run: |
          echo "Infrastructure deployed successfully!"
          echo "Web App URL: ${{ steps.deploy.outputs.webapp_url }}"

  # Cleanup (for development only)
  cleanup:
    name: Cleanup Development Resources
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev'
    environment:
      name: cleanup-approval
    
    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Delete Resource Group
        run: |
          echo "This would delete resource group: ${{ env.RESOURCE_GROUP_DEV }}"
          echo "Uncomment the following line to enable deletion:"
          # az group delete --name ${{ env.RESOURCE_GROUP_DEV }} --yes --no-wait
